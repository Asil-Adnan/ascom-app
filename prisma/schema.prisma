generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String?  @unique
  phone     String?  @unique
  username  String?  @unique // For Admins
  password  String?          // For Admins (hashed)
  otp       String?          // For Users (optional if using magic logic, but good for real impl)
  role      String   @default("USER") // USER, ADMIN, SUPER_ADMIN
  createdAt DateTime @default(now())

  profile      Profile?
  applications Application[]
  messages     Message[]

  // Wallet
  wallet       Wallet?

  // OTP
  otpCode      String?
  otpExpiry    DateTime?
}

model Profile {
  id              String   @id @default(cuid())
  userId          String   @unique
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Details
  firstName       String?
  lastName        String?
  gender          String?
  dateOfBirth     DateTime?
  nationality     String?
  maritalStatus   String?
  cityOfResidence String?
  
  // Passport Details
  passportNumber  String?
  passportExpiry  DateTime?
  passportCountry String? // Issuing Country
  
  // Documents (Stored as JSON: [{ type: 'passport', url: '...' }, ...])
  documents       String   @default("[]")
  
  updatedAt       DateTime @updatedAt
}

model Application {
  id        String   @id
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  type      String
  status    String   @default("DRAFT")
  step      Int      @default(1)
  data      String // Stored as JSON string
  documents String // Stored as JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]
}

model Message {
  id          String      @id @default(cuid())
  threadId    String
  application Application @relation(fields: [threadId], references: [id])
  senderRole  String
  senderId    String
  type        String      @default("TEXT")
  content     String
  attachments String? // Stored as JSON string: [{ url: string, name: string, type: string }]
  createdAt   DateTime    @default(now())
  user        User?       @relation(fields: [userId], references: [id])
  userId      String?
}

model BusListing {
  id                    String   @id @default(cuid())
  bus_code              String   @unique // e.g. DXB-OMN-001
  is_active             Boolean  @default(true)
  is_visible            Boolean  @default(true)
  bus_class             String   @default("Standard") // e.g. "Standard", "Luxury"

  // Route Info
  pickup_point          String
  departure_time        String   // "08:00 AM"
  dropoff_location      String
  expected_arrival_time String   // "01:00 PM"
  expected_return_time  String   // "01:00 PM"

  // Pricing (Display Only)
  base_price            Decimal  @db.Decimal(10, 2)
  visa_included_price   Decimal? @db.Decimal(10, 2)

  // Inclusions
  oman_visa_included    Boolean  @default(false)
  uae_visa_included     Boolean  @default(false)
  uae_visa_duration     String?  // "30_days" | "60_days"
  food_included         Boolean  @default(false)
  accommodation_included Boolean @default(false)
  exit_fee_included     Boolean  @default(false)

  // Marketing
  marketing_badge       String?  // e.g. "SELLING OUT", "SOLD OUT"

  // Admin Metadata
  internal_notes        String?  @db.Text
  created_by            String?

  available_dates       BusDate[]

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model BusDate {
  id        String     @id @default(cuid())
  date      DateTime   // Only the date part is significant
  busId     String
  bus       BusListing @relation(fields: [busId], references: [id], onDelete: Cascade)

  @@index([busId])
  @@index([date])
}

model Wallet {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance     Float    @default(0.0)
  currency    String   @default("AED")
  
  transactions WalletTransaction[]
  
  updatedAt   DateTime @updatedAt
}

model WalletTransaction {
  id          String   @id @default(cuid())
  walletId    String
  wallet      Wallet   @relation(fields: [walletId], references: [id], onDelete: Cascade)
  
  amount      Float
  type        String   // 'CREDIT' | 'DEBIT'
  reason      String?  // 'WELCOME_BONUS', 'PAYMENT', etc.
  referenceId String?  // Optional link to Payment or Application
  
  createdAt   DateTime @default(now())
}
